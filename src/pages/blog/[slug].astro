---
import BaseLayout from '@layouts/BaseLayout.astro';
import PostLayout from '@layouts/PostLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import Icon from '@components/UI/Icon.astro';

// Generate static paths for all blog posts
export async function getStaticPaths() {
  try {
    const blogEntries = await getCollection('blog', ({ data }) => {
      return import.meta.env.PROD ? !data.draft : true;
    });

    return blogEntries.map((entry) => ({
      params: { slug: entry.slug },
      props: { entry },
    }));
  } catch (error) {
    // If the collection doesn't exist yet, return an empty array
    return [];
  }
}

// Get the blog post data
const { entry } = Astro.props;
const { Content } = await entry.render();

// Find related posts (posts with matching tags)
let relatedPosts: CollectionEntry<'blog'>[] = [];
try {
  const allPosts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true;
  });

  // Find posts that share at least one tag with the current post
  const postTags = entry.data.tags || [];

  if (postTags.length > 0) {
    relatedPosts = allPosts
      .filter(
        (post) =>
          post.slug !== entry.slug && // Not the current post
          post.data.tags.some((tag) => postTags.includes(tag)), // Has at least one matching tag
      )
      .sort((a, b) => {
        // Sort by number of matching tags (descending)
        const aMatchCount = a.data.tags.filter((tag) =>
          postTags.includes(tag),
        ).length;
        const bMatchCount = b.data.tags.filter((tag) =>
          postTags.includes(tag),
        ).length;
        return bMatchCount - aMatchCount;
      })
      .slice(0, 3);
  }
} catch (error) {
  console.log('Error fetching related posts');
}
---

<BaseLayout
  title={`${entry.data.title} - Blog - Church Name`}
  description={entry.data.description}
  image={entry.data.image}
  type='article'
>
  <PostLayout
    title={entry.data.title}
    image={entry.data.image}
    date={entry.data.pubDate}
    author={entry.data.author}
    tags={entry.data.tags}
  >
    <!-- Blog Post Content -->
    <Content />

    <!-- Social Sharing -->
    <div class='mt-12 py-6 border-t border-gray-200'>
      <h3 class='text-lg font-bold mb-4'>Share This Post</h3>
      <div class='flex space-x-4'>
        <a
          href={`https://facebook.com/sharer/sharer.php?u=${Astro.url}`}
          target='_blank'
          rel='noopener noreferrer'
          class='text-gray-600 hover:text-blue-600 transition-colors'
          aria-label='Share on Facebook'
        >
          <Icon name='facebook' class='h-6 w-6' />
        </a>

        <a
          href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(entry.data.title)}&url=${Astro.url}`}
          target='_blank'
          rel='noopener noreferrer'
          class='text-gray-600 hover:text-blue-400 transition-colors'
          aria-label='Share on Twitter'
        >
          <Icon name='twitter' class='h-6 w-6' />
        </a>

        <a
          href={`mailto:?subject=${encodeURIComponent(entry.data.title)}&body=${encodeURIComponent(`I thought you might be interested in this article: ${Astro.url}`)}`}
          class='text-gray-600 hover:text-red-500 transition-colors'
          aria-label='Share via Email'
        >
          <Icon name='mail' class='h-6 w-6' />
        </a>
      </div>
    </div>

    <!-- Related Posts -->
    {
      relatedPosts.length > 0 && (
        <div class='mt-12'>
          <h2 class='text-2xl font-bold mb-6'>Related Posts</h2>
          <div class='grid grid-cols-1 md:grid-cols-3 gap-6'>
            {relatedPosts.map((post) => (
              <a
                href={`/blog/${post.slug}`}
                class='block bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors'
              >
                <h3 class='font-bold mb-2'>{post.data.title}</h3>
                <p class='text-sm text-gray-600 mb-2'>By {post.data.author}</p>
                <p class='text-primary-600 text-sm font-medium'>Read More â†’</p>
              </a>
            ))}
          </div>
        </div>
      )
    }

    <!-- Navigation -->
    <div class='mt-12'>
      <a
        href='/blog'
        class='inline-flex items-center text-primary-600 hover:text-primary-700'
      >
        <Icon name='arrow-left' class='h-5 w-5 mr-2' />
        Back to All Posts
      </a>
    </div>
  </PostLayout>
</BaseLayout>
