---
import BaseLayout from '@layouts/BaseLayout.astro';
import PageHeader from '@components/Sections/PageHeader.astro';
import Card from '@components/UI/Card.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '@utils/dateUtils';
import Icon from '@components/UI/Icon.astro';

// Get all blog posts
const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});

// Sort by date (newest first)
const posts = allPosts.sort(
  (a, b) =>
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime(),
);

// Get unique tags for filters
const tags = [...new Set(posts.flatMap((post) => post.data.tags))];
---

<BaseLayout
  title='Blog - Church Name'
  description='Read our latest articles, devotionals, and updates from our church community.'
>
  <PageHeader
    title='Blog'
    subtitle='Insights, devotionals, and updates from our church community'
    backgroundImage='/uploads/blog-header-bg.webp'
  />

  <!-- Blog Posts List -->
  <section class='py-16'>
    <div class='container'>
      <div class='grid grid-cols-1 lg:grid-cols-4 gap-8 min-h-screen'>
        <!-- Filters Sidebar -->
        <div class='lg:col-span-1'>
          <div
            class='bg-white p-6 rounded-lg shadow-sm sticky top-24 max-h-[calc(100vh-120px)] overflow-y-auto custom-scrollbar'
          >
            <h2 class='text-xl font-bold mb-6'>Filter Posts</h2>

            <!-- Search -->
            <div class='mb-6'>
              <label
                for='search'
                class='block text-sm font-medium text-gray-700 mb-1'
                >Search</label
              >
              <input
                type='text'
                id='search'
                placeholder='Search posts...'
                class='w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500'
              />
            </div>

            <!-- Tags Filter -->
            {
              tags.length > 0 && (
                <div class='mb-6'>
                  <h3 class='block text-sm font-medium text-gray-700 mb-2'>
                    Tags
                  </h3>
                  <div class='space-y-2'>
                    {tags.map((tag) => (
                      <label class='flex items-center'>
                        <input
                          type='checkbox'
                          class='tag-checkbox h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded'
                          value={tag}
                        />
                        <span class='ml-2 text-gray-700'>{tag}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )
            }

            <!-- Author Filter -->
            <div class='mb-6'>
              <label
                for='author'
                class='block text-sm font-medium text-gray-700 mb-1'
                >Author</label
              >
              <input
                type='text'
                id='author'
                placeholder='Filter by author...'
                class='w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500'
              />
            </div>

            <!-- Date Range Filter -->
            <div class='space-y-3'>
              <label class='block text-sm font-medium text-gray-700'
                >Date Range</label
              >

              <div>
                <label for='from-date' class='block text-xs text-gray-500 mb-1'
                  >From</label
                >
                <input
                  type='date'
                  id='from-date'
                  class='w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500'
                />
              </div>

              <div>
                <label for='to-date' class='block text-xs text-gray-500 mb-1'
                  >To</label
                >
                <input
                  type='date'
                  id='to-date'
                  class='w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500'
                />
              </div>
            </div>

            <!-- Reset Filters Button -->
            <button
              id='reset-filters'
              class='w-full mt-6 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2'
            >
              Reset Filters
            </button>
          </div>
        </div>

        <!-- Blog Posts Grid -->
        <div class='lg:col-span-3 min-h-screen'>
          <h2 class='text-2xl font-bold mb-6'>All Posts</h2>

          <div class='grid grid-cols-1 md:grid-cols-2 gap-8' id='posts-grid'>
            {
              posts.map((post) => (
                <Card
                  title={post.data.title}
                  image={
                    post.data.image && {
                      src: post.data.image.url,
                      alt: post.data.image.alt,
                    }
                  }
                  href={`/blog/${post.slug}`}
                  class='blog-card'
                  data-tags={post.data.tags.join(',')}
                  data-author={post.data.author}
                  data-date={post.data.pubDate.toISOString().slice(0, 10)}
                >
                  <div class='mb-3 flex items-center text-gray-600'>
                    <Icon name='calendar' class='h-5 w-5 mr-2' />
                    <span>{formatDate(post.data.pubDate)}</span>
                  </div>

                  <div class='mb-3 flex items-center text-gray-600'>
                    <Icon name='user' class='h-5 w-5 mr-2' />
                    <span>{post.data.author}</span>
                  </div>

                  <p class='text-gray-700 mb-4'>{post.data.description}</p>

                  {post.data.tags.length > 0 && (
                    <div class='flex flex-wrap gap-2 mb-4'>
                      {post.data.tags.map((tag) => (
                        <span class='px-2 py-1 text-xs font-medium text-primary-700 bg-primary-100 rounded-full'>
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}

                  <p class='text-primary-600 font-medium group-hover:underline group-hover:text-primary-700'>
                    Read More â†’
                  </p>
                </Card>
              ))
            }
          </div>

          <!-- No Results Message (Hidden by default) -->
          <div
            id='no-results'
            class='hidden text-center py-12 bg-gray-50 rounded-lg mt-8'
          >
            <p class='text-gray-600'>
              No posts match your search criteria. Please try different filters.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Selectors with Type Casting
      const searchInput = document.getElementById('search') as HTMLInputElement;
      const authorInput = document.getElementById('author') as HTMLInputElement;
      const tagCheckboxes = document.querySelectorAll(
        '.tag-checkbox',
      ) as NodeListOf<HTMLInputElement>;
      const fromDateInput = document.getElementById(
        'from-date',
      ) as HTMLInputElement;
      const toDateInput = document.getElementById(
        'to-date',
      ) as HTMLInputElement;
      const resetButton = document.getElementById(
        'reset-filters',
      ) as HTMLButtonElement;

      const postsGrid = document.getElementById('posts-grid') as HTMLElement;
      const noResults = document.getElementById('no-results') as HTMLElement;
      const blogCards = document.querySelectorAll(
        '.blog-card',
      ) as NodeListOf<HTMLElement>;

      // Helper to obtain clean text
      const getSafeText = (element: HTMLElement, selector: string): string => {
        const el = element.querySelector(selector);
        return el && el.textContent ? el.textContent.trim().toLowerCase() : '';
      };

      const filterPosts = () => {
        // 1. Obtain filter values
        const searchTerm = searchInput?.value.trim().toLowerCase() || '';
        const authorTerm = authorInput?.value.trim().toLowerCase() || '';
        const fromDate = fromDateInput?.value || '';
        const toDate = toDateInput?.value || '';

        // 2. Obtain selected tags
        const selectedTags = Array.from(tagCheckboxes)
          .filter((checkbox) => checkbox.checked)
          .map((checkbox) => checkbox.value.trim().toLowerCase());

        let visibleCount = 0;

        blogCards.forEach((card) => {
          // 3. Extract data from the card
          const title = getSafeText(card, 'h3');
          const description = getSafeText(card, 'p');
          const author = (card.getAttribute('data-author') || '').toLowerCase();
          const date = card.getAttribute('data-date') || '';

          // Process card tags
          const cardTagsString = card.getAttribute('data-tags') || '';
          // We convert "Family, Parenting" -> ["family", "parenting"]
          const cardTags = cardTagsString
            .toLowerCase()
            .split(',')
            .map((t) => t.trim());

          // --- VALIDATIONS ---
          const matchesSearch =
            searchTerm === '' ||
            title.includes(searchTerm) ||
            description.includes(searchTerm);

          const matchesAuthor =
            authorTerm === '' || author.includes(authorTerm);

          const matchesFromDate = !fromDate || date >= fromDate;
          const matchesToDate = !toDate || date <= toDate;

          // Check array intersection
          // If no tags are selected, skip. If there are, search for matches.
          const matchesTags =
            selectedTags.length === 0 ||
            selectedTags.some((tag) => cardTags.includes(tag));

          // --- FAULT DEBUGGING (For development only) ---
          // If you selected a tag and it did not match, this will tell you why in the console (F12).
          // if (selectedTags.length > 0 && !matchesTags) {
          //   console.log('The Tags Match failed:', {
          //     selected: selectedTags,
          //     inCard: cardTags,
          //     cardTitle: title,
          //   });
          // }

          // --- VISIBILITY ---
          if (
            matchesSearch &&
            matchesAuthor &&
            matchesFromDate &&
            matchesToDate &&
            matchesTags
          ) {
            card.style.display = 'block';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // Display no results message
        if (noResults) {
          noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }
        if (visibleCount > 0) {
          // 1. We are looking for the Header element.
          const header = document.querySelector('header');
          const headerHeight = header ? header.offsetHeight : 0;

          // 2. We define an extra margin (for example, 20px) so that it does not stick.
          const extraMargin = 20;
          const totalOffset = -(headerHeight + extraMargin);

          // 3. We calculate the exact position
          const y =
            postsGrid.getBoundingClientRect().top +
            window.pageYOffset +
            totalOffset;

          window.scrollTo({ top: y, behavior: 'smooth' });
        }
      };

      // Listeners
      searchInput?.addEventListener('input', filterPosts);
      authorInput?.addEventListener('input', filterPosts);

      tagCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', filterPosts);
      });
      fromDateInput?.addEventListener('change', filterPosts);
      toDateInput?.addEventListener('change', filterPosts);

      // Reset
      resetButton?.addEventListener('click', () => {
        if (searchInput) searchInput.value = '';
        if (authorInput) authorInput.value = '';
        if (fromDateInput) fromDateInput.value = '';
        if (toDateInput) toDateInput.value = '';
        tagCheckboxes.forEach((cb) => (cb.checked = false));
        filterPosts();
      });
    });
  </script>
</BaseLayout>
